<form id="budget-form" name="budget-form" method="POST">
  {{ form.budget_id(value=budget.id) }}
  {{ form.budget_json }}
  {{ form.csrf_token }}
  <div class="card card-body d-flex">
    <div class="form-inline">
      <label class="fs-rem-1-8" for="budget_name">Budget name:&nbsp;</label>
      <input class="form-control fs-rem-1-6" id="budget_name" name="budget_name" placeholder="My First Budget" maxlength="30" value="{{ budget.name if budget.name else '' }}">
      <div class="btn-group dropleft ml-auto">
        <i class="fas fa-2x fa-ellipsis-v"
            type="button"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"></i>
        <div class="dropdown-menu">
          {% if not current_user.is_authenticated %}
          <h6 class="dropdown-header">
            <a href="{{ url_for('users.login', next=url_for('finance.budget_page')) }}">Log in</a> to access disabled features
          </h6>
          {% endif %}
          <button class="dropdown-item{% if not current_user.is_authenticated %} disabled{% endif %}"
                  type="button"
                  ic-post-to="{{ url_for('finance.save_current_budget') }}"
                  ic-target='#budget-inner'>Save Budget</button>
          <button class="dropdown-item{% if not current_user.is_authenticated %} disabled{% endif %}"
                  type="button">Share Budget</button>
          <button class="dropdown-item"
                  type="button"
                  ic-confirm="Unsaved budget data will be deleted. Continue?"
                  ic-get-from="{{ url_for('finance.new_budget') }}"
                  ic-target='#budget-inner'>New Budget</button>
          <div class="dropdown-submenu">
            <button class="dropdown-item subdrop{% if not current_user.is_authenticated %} disabled{% endif %}"
                    type="button"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false">Select a Budget</button>
            <div class="dropdown-menu">
              {% for saved_budget in saved_budgets %}
                <button class="dropdown-item"
                        type="button"
                        ic-post-to="{{ url_for('finance.retrieve_budget', budget_id=saved_budget.id) }}"
                        ic-target='#budget-inner'>
                  <span>{{ saved_budget.name }}</span>
                  {% if saved_budget.id == budget.id %}
                  <span>&nbsp;(current)</span>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          </div>
          <div class="dropdown-submenu">
            <button class="dropdown-item subdrop{% if not current_user.is_authenticated %} disabled{% endif %}"
                    type="button"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false">Delete a Budget</button>
            <div class="dropdown-menu">
              {% for saved_budget in saved_budgets %}
                <button class="dropdown-item"
                        type="button"
                        ic-confirm="Are you sure you want to delete '{{ saved_budget.name }}'?"
                        ic-post-to="{{ url_for('finance.delete_budget', budget_id=saved_budget.id) }}"
                        ic-target='#budget-inner'>
                  <span>{{ saved_budget.name }}</span>
                  {% if saved_budget.id == budget.id %}
                  <span>&nbsp;(current)</span>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="form-inline">
        <label class="fs-rem-1-8" for="budget_view_period">View:&nbsp;</label>
        <select id="budget_view_period" name="budget_view_period" class="form-control">
          {% set period = budget.period %}
          {% include "finance/form_timeperiod_selector.html" %}
        </select>
    </div>
  </div>

  <div class="card">
    {% for category in budget.budget %}
    <div class="budget-category">
      <div data-toggle="collapse" data-target="#{{ id_safe(category) }}-Collapse" aria-expanded="false" aria-controls="{{ id_safe(category) }}-Collapse" class="cursor-pointer card-header fs-rem-1-8">
        <span class="category-label">{{ category }}</span>
        <span class="float-right category-total"></span>
      </div>
      <div id="{{ id_safe(category) }}-Collapse" class="collapse fs-rem-1-4">
        {% for item in budget.budget[category] %}
        <div id="{{ id_safe(category) }}-{{ loop.index }}" class="row budget-item">
          <div class="col-sm">
            <label class="budget-item-label" for="{{ id_safe(category) }}-{{ loop.index }}-value">{{ item }}</label>
          </div>
          <div class="col">
            <input class="form-control input-val" inputmode="decimal" type="number" id="{{ id_safe(category) }}-{{ loop.index }}-value" value="{{ budget.budget[category][item]['value'] if budget.budget[category][item]['value'] else '' }}">
          </div>
          <div class="col">
            <select class="form-control input-timeperiod" name="{{ id_safe(category) }}-{{ loop.index }}-select" id="{{ id_safe(category) }}-{{ loop.index }}-select">
            {% set period = budget.budget[category][item]["period"] %}
            {% include "finance/form_timeperiod_selector.html" %}
            </select>
          </div>
          <div class="col text-right">
            <span class="item-total" id="{{ id_safe(category) }}-{{ loop.index }}-total">$0</span>
            <span class="item-pos" hidden aria-hidden="true">{{ budget.budget[category][item].get("pos", "False") }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="card">
    <div id="budget-summary">
      <div data-toggle="collapse" data-target="#budgetSummary-Collapse" aria-expanded="false" aria-controls="budgetSummary-Collapse" class="cursor-pointer card-header fs-rem-1-8">
        <span class="summary-label">Summary</span>
        <span class="float-right summary-total"></span>
      </div>
      <div id="budgetSummary-Collapse" class="collapse fs-rem-1-4">
        <h2>GRAPHS GO HERE</h2>
      </div>
    </div>
  </div>
</form>

{% if refresh_js %}
<script>
  budgetSummary = new BudgetSummary($(domStrings.budgetSummary))
  budgetSummary.createBudgetCategories()
  $(domStrings.budgetName).change(() => {
    budgetUpdatedTime = new Date()
  })
  $(domStrings.viewTimePeriod).change(() => {
    budgetUpdatedTime = new Date()
  })
  setBudgetJson()
  setInterval(stashBudget, 15000)
  readyDropdownSubmenus()
</script>
{% endif %}
